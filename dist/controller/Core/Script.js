"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{"default":e}};Object.defineProperty(exports,"__esModule",{value:!0});const Execute_1=__importDefault(require("@/Models/Database/Entities/Execute")),Script_1=__importDefault(require("@/Models/Database/Entities/Script")),fs_1=require("fs"),Exception_1=__importDefault(require("./Exception")),promises_1=require("fs/promises"),crypto_1=require("crypto"),zod_1=__importDefault(require("zod"));class Script{static broadcast;id;createdAt;filename;name;hrefRegex;ipRegex;content;isActive;constructor(e){this.id=e.id,this.createdAt=e.createdAt,this.name=e.name,this.hrefRegex=e.hrefRegex,this.ipRegex=e.ipRegex,this.filename=e.filename,this.content=(0,fs_1.readFileSync)("storage/scripts/"+e.filename,{encoding:"utf-8"}),this.isActive=e.isActive}static async create(e){var{name:e,hrefRegex:t,ipRegex:i,content:r}=zod_1["default"].object({name:zod_1["default"].string().min(1).max(30),hrefRegex:zod_1["default"].string().optional(),ipRegex:zod_1["default"].string().optional(),content:zod_1["default"].string().min(5)}).parse(e),a=new Script_1["default"];a.name=e,a.hrefRegex=t||null,a.ipRegex=i||null;do{a.filename=(0,crypto_1.randomUUID)()+".js";var n="storage/scripts/"+a.filename}while((0,fs_1.existsSync)(n));return(0,fs_1.writeFileSync)(n,r),await a.save(),new this(a)}static async find(){return(await Script_1["default"].find({order:{id:"DESC"}})).map(e=>new this(e))}static async findOne(e){e=await Script_1["default"].findOneBy({id:zod_1["default"].number().parse(e)});if(e)return new this(e);throw new Exception_1["default"]("This entity was not found")}async edit(e){var{name:e,hrefRegex:t,ipRegex:i,content:r}=zod_1["default"].object({name:zod_1["default"].string().min(1).max(30),hrefRegex:zod_1["default"].string().nullable(),ipRegex:zod_1["default"].string().nullable(),content:zod_1["default"].string().min(5)}).parse(e),a=await Script_1["default"].findOneByOrFail({id:this.id}),e=(a.name=e,a.hrefRegex=t,a.ipRegex=i,"storage/scripts/"+a.filename);return(0,fs_1.writeFileSync)(e,r),Object.assign(this,a),this.content=r,await a.save(),this}async destroy(){return await(await Script_1["default"].findOneByOrFail({id:this.id})).remove(),await(0,promises_1.unlink)("storage/scripts/"+this.filename),!0}async changeStatus(){var e=await Script_1["default"].findOneByOrFail({id:this.id});return e.isActive=!e.isActive,await e.save(),this.isActive=e.isActive,this.isActive}static async filter(e){const{href:r,ip:a}=zod_1["default"].object({href:zod_1["default"].string().optional(),ip:zod_1["default"].string().optional()}).parse(e);return(await Script_1["default"].findBy({isActive:!0})).filter(function(e){try{if(e.hrefRegex){var t=new RegExp(e.hrefRegex,"gi");if(!r||!t.test(r))return!1}if(e.ipRegex){var i=new RegExp(e.ipRegex,"gi");if(!a||!i.test(a))return!1}return!0}catch{return!1}}).map(e=>new this(e))}async lastExecutes(){return Execute_1["default"].find({where:{script:{id:this.id}},take:7,order:{id:"DESC"}})}async countExecutes(){return Execute_1["default"].countBy({script:{id:this.id}})}}exports["default"]=Script;